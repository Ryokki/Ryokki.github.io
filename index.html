<!DOCTYPE html>
<html lang="zh"><head>
	<meta name="generator" content="Hugo 0.129.0">
<title>Ryokki Blog</title>



  


<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=5" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">















  






    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://ryokki.github.io/">
            Ryokki Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://ryokki.github.io/">
        <div class="single-column-header-title">Ryokki Blog</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-no-background">
        
        
            <a href="/posts/021.-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/" class="a-block">
                <div class="post-item-wrapper">
                    <div class="post-item post-item-no-divider">
                        <div class="post-item-info-wrapper">
                            <div class="post-item-title">
                                内存屏障的前世今生
                            </div>
                            <div class="post-item-summary">
                                
                                    参考 Locks实现:背后不为人知的故事 - MySpace
以及下面两个视频很清楚解释了cpu cache,MESI, store buffer/invalidation queue, 内存屏障的历史演进
【面试官问我MESI如何保证内存一致性，我把这个动画甩给他】 https://www.bilibili.com/video/BV1kD4y1T7XU/?share_source=copy_web&amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de 【美团一面问我内存屏障和volatile的关系，我说了20分钟】 https://www.bilibili.com/video/BV1cT411a7Sn/?share_source=copy_web&amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de 多个CPU或CPU Core之间通过总线连接； CPU通过总线与主存（memory）连接； 每个CPU都有自己的本地cache，通过cache一致性协议（如MESI/MESIF）与其他CPU Core维护一个一致的数据视图； 引入store buffer CPU对cacheline的修改，若直接落cache，一致性协议会引入不小的开销（执行cache一致性协议），CPU会stall执行的指令。为了提高指令吞吐，这里引入了store buffer。
数据更新不直接写cacheline而是先写到store buffer，后面需要时再落cache并通知其他cache失效（执行cache一致性协议），这样CPU就可以减少stall继续执行指令（store buffer刷新过程不需要cpu参与）。
💡单核时保证了一致性
store buffer是个FIFO，同个cpu两个写操作一定是顺序执行的 同个cpu先写后读，不会出现读到旧数据的情况，因为读的时候会检查store buffer是否有同个地址的写操作 引入invalidate queue CPU cache更新cacheline后，通知其他CPU更新cache，需通过cache一致性协议，如MESI/MESIF消息invalidate。
正常来说，收到此通知的CPU应从cache中将对应cacheline标记为无效，但是如果立即执行这个动作的话，CPU会频繁被阻断执行，所以CPU中引入了invalidate queue，收到invalidate通知后缓存起来并立即回复ACK，但延迟处理。
（invalidate queue 刷新过程不需要cpu参与）
引入的问题 这么设计引入的问题：
store buffer：本地cache更新不能立即被其他CPU或者CPU core观测到了，写操作对外不可见； invalidate queue：本地cache没有立即更新数据，上层应用看不到其他CPU更新的数据（其实就是第一点，写操作对外不可见） 处理器执行操作变化 如果没有store buffer、invalidate queue，MESI，cache如何工作？
当包含变量a的cacheline，其被CPU 0和CPU 1共享，当CPU 0更新该cacheline之后，会发送invalidate给CPU 1，CPU 1随即把对应的cacheline标记为invalidate； 当CPU 1下次读取变量a的cacheline时，发现标记为了无效，此时发出read请求，CPU 0观测到自己这边对应的cacheline是modified状态，cacheline是最新的，此时会将对应cacheline数据发送给CPU 1，这样CPU 1就观测到了最新的数据； CPU 0中cacheline何时写回主存？可能是被淘汰的时候，也可能是别人read的时候，这个我们先不关心。 如果引入了store buffer、invalidate queue之后，又该如何工作呢？
必须要有办法，将该store buffer中的更新，通知到其他CPU，这就是write barrier干的事情。它就是暂停CPU 0执行，并将CPU 0把store buffer中记录的一些更新应用到cache中，此时会触发cache一致性协议MESI通知CPU 1 cacheline invalidate； 必须要有办法，将CPU 1中invalidate queue记录下来的invalidate对应的cacheline及时清理掉，这就是read barrier干的事情。它就是暂停CPU 1执行，将其invalidate queue中的每个invalidate请求对应的cacheline全部标记为无效，下次读取时从内存或者CPU 0读取最新数据； 内存屏障 这里的读写屏障要依赖处理器提供的屏障指令 在屏障指令之上，内核可以按需选择，如Linux在x86平台选择用 lock; addl来实现读写屏障 smp_mb/smp_rmb/smp_wmb，x86其实也提供了mfence、lfence、sfence。至于Linux为什么这么选择，应该是跟x86实现有关系，一条指令 lock;addl同时实现全屏障/读屏障/写屏障足矣。 其他编程语言内存模型，通常会定义一些Happens-Before关系，这里面就隐含了各种屏障的应用。基于屏障实现的各种同步原语如mutex、semaphore等就比较常见了 写操作后加入写屏障，就会刷新该cpu的所有store buffer，刷到其他cpu的invaliate queue 读操作前加入读屏障，就会消费当前cpu的所有invalidate DeepSeek-R1对演进史的梳理 帮我这个笔记做下补充，例如展开说说演进的历史（结合时间），更具体的例子等等 cpu-memory很慢，引入cache 由于每个cpu都有各自的cache，修改时需要保证其他缓存失效，收到ack后才能继续修改 引入两个队列 Store Buffer：用于提升写操作的性能。更新内存时，直接扔到buffer中，异步更新。buffer执行更新时，也一样是收到其他cpu的缓存失效ack后才能修改【简而言之，Store Buffer 就像一个 “写操作缓冲区”，让 CPU 可以 “先写先走”，从而避免写操作成为性能瓶颈。】 Invalid Queue: Invalidation Queue 的作用就是异步地接收和处理这些来自其他 CPU Core 的 Invalidate Request。 当 CPU Core (例如 CPU1) 收到来自 CPU0 的 Invalidate Request 时，它不会立即暂停当前正在执行的任务，去同步处理缓存失效。 相反，它会将收到的 Invalidate Request 先放入 Invalidation Queue 中排队。 CPU Core 可以继续执行后续的指令，而 Invalidation Queue 会在 后台异步地 从队列中取出 Invalidate Request，并执行相应的缓存失效操作 (例如，标记 Cache Line 为 Invalid)。【简而言之，Invalidation Queue 就像一个 “失效请求缓冲区”，让 CPU 可以异步地处理来自其他 Core 的失效请求，避免因等待失效处理而阻塞 CPU 的正常执行。】 最后的总结很好：cache-&gt;mesi-&gt;two queue-&gt;barrier的演进 好的！我将结合时间线、具体案例和技术细节，补充并扩展您的笔记内容：
                                
                            </div>
                            <div class="post-item-meta">
    2025-02-19
    &emsp;
    
    
    
    &emsp;
    
</div>

                        </div>
                        
                        
                    </div>
                </div>
        
            <a href="/now/" class="a-block">
                <div class="post-item-wrapper">
                    <div class="post-item post-item-no-divider">
                        <div class="post-item-info-wrapper">
                            <div class="post-item-title">
                                Now
                            </div>
                            <div class="post-item-summary">
                                
                                    看小白debug[[小白debug]]，可以快速过一遍很多中间件
Now 页面会随着时间和当下生活的优先级而更新，用来让别人看见这个人现在生活的重点是什么，和提醒自己专注于当下最重要的事。
学习优先级：（gitlet没动力了写了～～ 感觉没啥用 鸽了 还是想回归基础）
15-445
软件设计原则/设计模式/clean architecture
mysql是怎样运行的
csapp
6.S081
corekv
看看Comparator设计
尝试做一个chrome extesion，像parse medium这样简单的就可以啦
代码转sql的做个插件 https://ssshooter.com/intellij-plugin-dev/ https://github.com/fuzhengwei/guide-idea-plugin
学netty
看看我们AI的rag是怎么做的，
看一下腾讯问卷DSL设计
学做虾
闷骚的程序员 - 知乎
重新启动游泳～
读on java8重要章节
拓扑排序
how gradle/maven works
Signals. I spent 2 years to understand this part. - YouTube Sending and Handling Signals in C (kill, signal, sigaction) - YouTube
研究学习的整个workflow（包括信息接收，信息存储，项目/时间管理），以及学习方法[[workflow and method]]
git learn
学习(预计10h): (看一些blog &amp;&amp; 调试rezero的代码) 学习workflow中看代码的方法，结合实践，写一篇blog 输出: git internal blog 知识应用(预计20h): gitlet 优惠券系统设计 &amp; 分销系统设计 总结
                                
                            </div>
                            <div class="post-item-meta">
    2024-05-16
    &emsp;
    
    
    
    &emsp;
    
</div>

                        </div>
                        
                        
                    </div>
                </div>
        
            <a href="/about/" class="a-block">
                <div class="post-item-wrapper">
                    <div class="post-item post-item-no-divider">
                        <div class="post-item-info-wrapper">
                            <div class="post-item-title">
                                
                            </div>
                            <div class="post-item-summary">
                                
                                    love cs and kkbabe.
                                
                            </div>
                            <div class="post-item-meta">
    0001-01-01
    &emsp;
    
    
    
    &emsp;
    
</div>

                        </div>
                        
                        
                    </div>
                </div>
        
            <a href="/notes/" class="a-block">
                <div class="post-item-wrapper">
                    <div class="post-item post-item-no-divider">
                        <div class="post-item-info-wrapper">
                            <div class="post-item-title">
                                
                            </div>
                            <div class="post-item-summary">
                                
                                    Go 语言学习笔记 Envoy 学习笔记 
                                
                            </div>
                            <div class="post-item-meta">
    0001-01-01
    &emsp;
    
    
    
    &emsp;
    
</div>

                        </div>
                        
                        
                    </div>
                </div>
        
            <a href="/search/placeholder/" class="a-block">
                <div class="post-item-wrapper">
                    <div class="post-item post-item-no-divider">
                        <div class="post-item-info-wrapper">
                            <div class="post-item-title">
                                
                            </div>
                            <div class="post-item-summary">
                                
                                    
                                
                            </div>
                            <div class="post-item-meta">
    0001-01-01
    &emsp;
    
    
    
    &emsp;
    
</div>

                        </div>
                        
                        
                    </div>
                </div>
        
            <a href="/archive/" class="a-block">
                <div class="post-item-wrapper">
                    <div class="post-item post-item-no-divider">
                        <div class="post-item-info-wrapper">
                            <div class="post-item-title">
                                Posts Archive
                            </div>
                            <div class="post-item-summary">
                                
                                    Archive of historical posts.
                                
                            </div>
                            <div class="post-item-meta">
    0001-01-01
    &emsp;
    
    
    
    &emsp;
    
</div>

                        </div>
                        
                        
                    </div>
                </div>
        
        </a>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head active" href="https://ryokki.github.io/">
    
        <div class="nav-title">
            Ryokki Blog
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2025 Ryokki Blog
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
        
        
    </div>
</div>




<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2025 Ryokki Blog
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
