<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.129.0">

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Kaijian Xu" />
  <meta property="og:url" content="https://ryokki.github.io/posts/021.-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/" />
  <link rel="canonical" href="https://ryokki.github.io/posts/021.-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/" /><link rel="alternate" type="application/atom+xml" href="https://ryokki.github.io/index.xml" title="XKJ Blog">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/ryokki.github.io\/"
      },
      "articleSection" : "posts",
      "name" : "å†…å­˜å±éšœçš„å‰ä¸–ä»Šç”Ÿ",
      "headline" : "å†…å­˜å±éšœçš„å‰ä¸–ä»Šç”Ÿ",
      "description" : "å‚è€ƒ Lockså®ç°:èƒŒåä¸ä¸ºäººçŸ¥çš„æ•…äº‹ - MySpace\nä»¥åŠä¸‹é¢ä¸¤ä¸ªè§†é¢‘å¾ˆæ¸…æ¥šè§£é‡Šäº†cpu cache,MESI, store buffer\/invalidation queue, å†…å­˜å±éšœçš„å†å²æ¼”è¿›\nã€é¢è¯•å®˜é—®æˆ‘MESIå¦‚ä½•ä¿è¯å†…å­˜ä¸€è‡´æ€§ï¼Œæˆ‘æŠŠè¿™ä¸ªåŠ¨ç”»ç”©ç»™ä»–ã€‘ https:\/\/www.bilibili.com\/video\/BV1kD4y1T7XU\/?share_source=copy_web\u0026amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de ã€ç¾å›¢ä¸€é¢é—®æˆ‘å†…å­˜å±éšœå’Œvolatileçš„å…³ç³»ï¼Œæˆ‘è¯´äº†20åˆ†é’Ÿã€‘ https:\/\/www.bilibili.com\/video\/BV1cT411a7Sn\/?share_source=copy_web\u0026amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de å¤šä¸ªCPUæˆ–CPU Coreä¹‹é—´é€šè¿‡æ€»çº¿è¿æ¥ï¼› CPUé€šè¿‡æ€»çº¿ä¸ä¸»å­˜ï¼ˆmemoryï¼‰è¿æ¥ï¼› æ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„æœ¬åœ°cacheï¼Œé€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼ˆå¦‚MESI\/MESIFï¼‰ä¸å…¶ä»–CPU Coreç»´æŠ¤ä¸€ä¸ªä¸€è‡´çš„æ•°æ®è§†å›¾ï¼› å¼•å…¥store buffer CPUå¯¹cachelineçš„ä¿®æ”¹ï¼Œè‹¥ç›´æ¥è½cacheï¼Œä¸€è‡´æ€§åè®®ä¼šå¼•å…¥ä¸å°çš„å¼€é”€ï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼ŒCPUä¼šstallæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸ºäº†æé«˜æŒ‡ä»¤ååï¼Œè¿™é‡Œå¼•å…¥äº†store bufferã€‚\næ•°æ®æ›´æ–°ä¸ç›´æ¥å†™cachelineè€Œæ˜¯å…ˆå†™åˆ°store bufferï¼Œåé¢éœ€è¦æ—¶å†è½cacheå¹¶é€šçŸ¥å…¶ä»–cacheå¤±æ•ˆï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼Œè¿™æ ·CPUå°±å¯ä»¥å‡å°‘stallç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆstore bufferåˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰ã€‚\nğŸ’¡å•æ ¸æ—¶ä¿è¯äº†ä¸€è‡´æ€§\nstore bufferæ˜¯ä¸ªFIFOï¼ŒåŒä¸ªcpuä¸¤ä¸ªå†™æ“ä½œä¸€å®šæ˜¯é¡ºåºæ‰§è¡Œçš„ åŒä¸ªcpuå…ˆå†™åè¯»ï¼Œä¸ä¼šå‡ºç°è¯»åˆ°æ—§æ•°æ®çš„æƒ…å†µï¼Œå› ä¸ºè¯»çš„æ—¶å€™ä¼šæ£€æŸ¥store bufferæ˜¯å¦æœ‰åŒä¸ªåœ°å€çš„å†™æ“ä½œ å¼•å…¥invalidate queue CPU cacheæ›´æ–°cachelineåï¼Œé€šçŸ¥å…¶ä»–CPUæ›´æ–°cacheï¼Œéœ€é€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼Œå¦‚MESI\/MESIFæ¶ˆæ¯invalidateã€‚\næ­£å¸¸æ¥è¯´ï¼Œæ”¶åˆ°æ­¤é€šçŸ¥çš„CPUåº”ä»cacheä¸­å°†å¯¹åº”cachelineæ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†æ˜¯å¦‚æœç«‹å³æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œçš„è¯ï¼ŒCPUä¼šé¢‘ç¹è¢«é˜»æ–­æ‰§è¡Œï¼Œæ‰€ä»¥CPUä¸­å¼•å…¥äº†invalidate queueï¼Œæ”¶åˆ°invalidateé€šçŸ¥åç¼“å­˜èµ·æ¥å¹¶ç«‹å³å›å¤ACKï¼Œä½†å»¶è¿Ÿå¤„ç†ã€‚\nï¼ˆinvalidate queue åˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰\nå¼•å…¥çš„é—®é¢˜ è¿™ä¹ˆè®¾è®¡å¼•å…¥çš„é—®é¢˜ï¼š\nstore bufferï¼šæœ¬åœ°cacheæ›´æ–°ä¸èƒ½ç«‹å³è¢«å…¶ä»–CPUæˆ–è€…CPU coreè§‚æµ‹åˆ°äº†ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼› invalidate queueï¼šæœ¬åœ°cacheæ²¡æœ‰ç«‹å³æ›´æ–°æ•°æ®ï¼Œä¸Šå±‚åº”ç”¨çœ‹ä¸åˆ°å…¶ä»–CPUæ›´æ–°çš„æ•°æ®ï¼ˆå…¶å®å°±æ˜¯ç¬¬ä¸€ç‚¹ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼‰ å¤„ç†å™¨æ‰§è¡Œæ“ä½œå˜åŒ– å¦‚æœæ²¡æœ‰store bufferã€invalidate queueï¼ŒMESIï¼Œcacheå¦‚ä½•å·¥ä½œï¼Ÿ\nå½“åŒ…å«å˜é‡açš„cachelineï¼Œå…¶è¢«CPU 0å’ŒCPU 1å…±äº«ï¼Œå½“CPU 0æ›´æ–°è¯¥cachelineä¹‹åï¼Œä¼šå‘é€invalidateç»™CPU 1ï¼ŒCPU 1éšå³æŠŠå¯¹åº”çš„cachelineæ ‡è®°ä¸ºinvalidateï¼› å½“CPU 1ä¸‹æ¬¡è¯»å–å˜é‡açš„cachelineæ—¶ï¼Œå‘ç°æ ‡è®°ä¸ºäº†æ— æ•ˆï¼Œæ­¤æ—¶å‘å‡ºreadè¯·æ±‚ï¼ŒCPU 0è§‚æµ‹åˆ°è‡ªå·±è¿™è¾¹å¯¹åº”çš„cachelineæ˜¯modifiedçŠ¶æ€ï¼Œcachelineæ˜¯æœ€æ–°çš„ï¼Œæ­¤æ—¶ä¼šå°†å¯¹åº”cachelineæ•°æ®å‘é€ç»™CPU 1ï¼Œè¿™æ ·CPU 1å°±è§‚æµ‹åˆ°äº†æœ€æ–°çš„æ•°æ®ï¼› CPU 0ä¸­cachelineä½•æ—¶å†™å›ä¸»å­˜ï¼Ÿå¯èƒ½æ˜¯è¢«æ·˜æ±°çš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ«äººreadçš„æ—¶å€™ï¼Œè¿™ä¸ªæˆ‘ä»¬å…ˆä¸å…³å¿ƒã€‚ å¦‚æœå¼•å…¥äº†store bufferã€invalidate queueä¹‹åï¼Œåˆè¯¥å¦‚ä½•å·¥ä½œå‘¢ï¼Ÿ\nå¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†è¯¥store bufferä¸­çš„æ›´æ–°ï¼Œé€šçŸ¥åˆ°å…¶ä»–CPUï¼Œè¿™å°±æ˜¯write barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 0æ‰§è¡Œï¼Œå¹¶å°†CPU 0æŠŠstore bufferä¸­è®°å½•çš„ä¸€äº›æ›´æ–°åº”ç”¨åˆ°cacheä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘cacheä¸€è‡´æ€§åè®®MESIé€šçŸ¥CPU 1 cacheline invalidateï¼› å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†CPU 1ä¸­invalidate queueè®°å½•ä¸‹æ¥çš„invalidateå¯¹åº”çš„cachelineåŠæ—¶æ¸…ç†æ‰ï¼Œè¿™å°±æ˜¯read barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 1æ‰§è¡Œï¼Œå°†å…¶invalidate queueä¸­çš„æ¯ä¸ªinvalidateè¯·æ±‚å¯¹åº”çš„cachelineå…¨éƒ¨æ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸‹æ¬¡è¯»å–æ—¶ä»å†…å­˜æˆ–è€…CPU 0è¯»å–æœ€æ–°æ•°æ®ï¼› å†…å­˜å±éšœ è¿™é‡Œçš„è¯»å†™å±éšœè¦ä¾èµ–å¤„ç†å™¨æä¾›çš„å±éšœæŒ‡ä»¤ åœ¨å±éšœæŒ‡ä»¤ä¹‹ä¸Šï¼Œå†…æ ¸å¯ä»¥æŒ‰éœ€é€‰æ‹©ï¼Œå¦‚Linuxåœ¨x86å¹³å°é€‰æ‹©ç”¨ lock; addlæ¥å®ç°è¯»å†™å±éšœ smp_mb\/smp_rmb\/smp_wmbï¼Œx86å…¶å®ä¹Ÿæä¾›äº†mfenceã€lfenceã€sfenceã€‚è‡³äºLinuxä¸ºä»€ä¹ˆè¿™ä¹ˆé€‰æ‹©ï¼Œåº”è¯¥æ˜¯è·Ÿx86å®ç°æœ‰å…³ç³»ï¼Œä¸€æ¡æŒ‡ä»¤ lock;addlåŒæ—¶å®ç°å…¨å±éšœ\/è¯»å±éšœ\/å†™å±éšœè¶³çŸ£ã€‚ å…¶ä»–ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹ï¼Œé€šå¸¸ä¼šå®šä¹‰ä¸€äº›Happens-Beforeå…³ç³»ï¼Œè¿™é‡Œé¢å°±éšå«äº†å„ç§å±éšœçš„åº”ç”¨ã€‚åŸºäºå±éšœå®ç°çš„å„ç§åŒæ­¥åŸè¯­å¦‚mutexã€semaphoreç­‰å°±æ¯”è¾ƒå¸¸è§äº† å†™æ“ä½œååŠ å…¥å†™å±éšœï¼Œå°±ä¼šåˆ·æ–°è¯¥cpuçš„æ‰€æœ‰store bufferï¼Œåˆ·åˆ°å…¶ä»–cpuçš„invaliate queue è¯»æ“ä½œå‰åŠ å…¥è¯»å±éšœï¼Œå°±ä¼šæ¶ˆè´¹å½“å‰cpuçš„æ‰€æœ‰invalidate DeepSeek-R1å¯¹æ¼”è¿›å²çš„æ¢³ç† å¸®æˆ‘è¿™ä¸ªç¬”è®°åšä¸‹è¡¥å……ï¼Œä¾‹å¦‚å±•å¼€è¯´è¯´æ¼”è¿›çš„å†å²ï¼ˆç»“åˆæ—¶é—´ï¼‰ï¼Œæ›´å…·ä½“çš„ä¾‹å­ç­‰ç­‰ cpu-memoryå¾ˆæ…¢ï¼Œå¼•å…¥cache ç”±äºæ¯ä¸ªcpuéƒ½æœ‰å„è‡ªçš„cacheï¼Œä¿®æ”¹æ—¶éœ€è¦ä¿è¯å…¶ä»–ç¼“å­˜å¤±æ•ˆï¼Œæ”¶åˆ°ackåæ‰èƒ½ç»§ç»­ä¿®æ”¹ å¼•å…¥ä¸¤ä¸ªé˜Ÿåˆ— Store Bufferï¼šç”¨äºæå‡å†™æ“ä½œçš„æ€§èƒ½ã€‚æ›´æ–°å†…å­˜æ—¶ï¼Œç›´æ¥æ‰”åˆ°bufferä¸­ï¼Œå¼‚æ­¥æ›´æ–°ã€‚bufferæ‰§è¡Œæ›´æ–°æ—¶ï¼Œä¹Ÿä¸€æ ·æ˜¯æ”¶åˆ°å…¶ä»–cpuçš„ç¼“å­˜å¤±æ•ˆackåæ‰èƒ½ä¿®æ”¹ã€ç®€è€Œè¨€ä¹‹ï¼ŒStore Buffer å°±åƒä¸€ä¸ª â€œå†™æ“ä½œç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥ â€œå…ˆå†™å…ˆèµ°â€ï¼Œä»è€Œé¿å…å†™æ“ä½œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ã€‘ Invalid Queue: Invalidation Queue çš„ä½œç”¨å°±æ˜¯å¼‚æ­¥åœ°æ¥æ”¶å’Œå¤„ç†è¿™äº›æ¥è‡ªå…¶ä»– CPU Core çš„ Invalidate Requestã€‚ å½“ CPU Core (ä¾‹å¦‚ CPU1) æ”¶åˆ°æ¥è‡ª CPU0 çš„ Invalidate Request æ—¶ï¼Œå®ƒä¸ä¼šç«‹å³æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå»åŒæ­¥å¤„ç†ç¼“å­˜å¤±æ•ˆã€‚ ç›¸åï¼Œå®ƒä¼šå°†æ”¶åˆ°çš„ Invalidate Request å…ˆæ”¾å…¥ Invalidation Queue ä¸­æ’é˜Ÿã€‚ CPU Core å¯ä»¥ç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ï¼Œè€Œ Invalidation Queue ä¼šåœ¨ åå°å¼‚æ­¥åœ° ä»é˜Ÿåˆ—ä¸­å–å‡º Invalidate Requestï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ç¼“å­˜å¤±æ•ˆæ“ä½œ (ä¾‹å¦‚ï¼Œæ ‡è®° Cache Line ä¸º Invalid)ã€‚ã€ç®€è€Œè¨€ä¹‹ï¼ŒInvalidation Queue å°±åƒä¸€ä¸ª â€œå¤±æ•ˆè¯·æ±‚ç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥å¼‚æ­¥åœ°å¤„ç†æ¥è‡ªå…¶ä»– Core çš„å¤±æ•ˆè¯·æ±‚ï¼Œé¿å…å› ç­‰å¾…å¤±æ•ˆå¤„ç†è€Œé˜»å¡ CPU çš„æ­£å¸¸æ‰§è¡Œã€‚ã€‘ æœ€åçš„æ€»ç»“å¾ˆå¥½ï¼šcache-\u0026gt;mesi-\u0026gt;two queue-\u0026gt;barrierçš„æ¼”è¿› å¥½çš„ï¼æˆ‘å°†ç»“åˆæ—¶é—´çº¿ã€å…·ä½“æ¡ˆä¾‹å’ŒæŠ€æœ¯ç»†èŠ‚ï¼Œè¡¥å……å¹¶æ‰©å±•æ‚¨çš„ç¬”è®°å†…å®¹ï¼š",
      "inLanguage" : "en-US",
      "author" : "Kaijian Xu",
      "creator" : "Kaijian Xu",
      "publisher": "Kaijian Xu",
      "accountablePerson" : "Kaijian Xu",
      "copyrightHolder" : "Kaijian Xu",
      "copyrightYear" : "2025",
      "datePublished": "2025-02-19 00:00:00 \u002b0000 UTC",
      "dateModified" : "2025-02-19 00:00:00 \u002b0000 UTC",
      "url" : "https:\/\/ryokki.github.io\/posts\/021.-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F\/",
      "keywords" : [  ]
  }
</script>
<title>å†…å­˜å±éšœçš„å‰ä¸–ä»Šç”Ÿ</title>
  <meta property="og:title" content="å†…å­˜å±éšœçš„å‰ä¸–ä»Šç”Ÿ" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="å‚è€ƒ Lockså®ç°:èƒŒåä¸ä¸ºäººçŸ¥çš„æ•…äº‹ - MySpace
ä»¥åŠä¸‹é¢ä¸¤ä¸ªè§†é¢‘å¾ˆæ¸…æ¥šè§£é‡Šäº†cpu cache,MESI, store buffer/invalidation queue, å†…å­˜å±éšœçš„å†å²æ¼”è¿›
ã€é¢è¯•å®˜é—®æˆ‘MESIå¦‚ä½•ä¿è¯å†…å­˜ä¸€è‡´æ€§ï¼Œæˆ‘æŠŠè¿™ä¸ªåŠ¨ç”»ç”©ç»™ä»–ã€‘ https://www.bilibili.com/video/BV1kD4y1T7XU/?share_source=copy_web&amp;amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de ã€ç¾å›¢ä¸€é¢é—®æˆ‘å†…å­˜å±éšœå’Œvolatileçš„å…³ç³»ï¼Œæˆ‘è¯´äº†20åˆ†é’Ÿã€‘ https://www.bilibili.com/video/BV1cT411a7Sn/?share_source=copy_web&amp;amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de å¤šä¸ªCPUæˆ–CPU Coreä¹‹é—´é€šè¿‡æ€»çº¿è¿æ¥ï¼› CPUé€šè¿‡æ€»çº¿ä¸ä¸»å­˜ï¼ˆmemoryï¼‰è¿æ¥ï¼› æ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„æœ¬åœ°cacheï¼Œé€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼ˆå¦‚MESI/MESIFï¼‰ä¸å…¶ä»–CPU Coreç»´æŠ¤ä¸€ä¸ªä¸€è‡´çš„æ•°æ®è§†å›¾ï¼› å¼•å…¥store buffer CPUå¯¹cachelineçš„ä¿®æ”¹ï¼Œè‹¥ç›´æ¥è½cacheï¼Œä¸€è‡´æ€§åè®®ä¼šå¼•å…¥ä¸å°çš„å¼€é”€ï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼ŒCPUä¼šstallæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸ºäº†æé«˜æŒ‡ä»¤ååï¼Œè¿™é‡Œå¼•å…¥äº†store bufferã€‚
æ•°æ®æ›´æ–°ä¸ç›´æ¥å†™cachelineè€Œæ˜¯å…ˆå†™åˆ°store bufferï¼Œåé¢éœ€è¦æ—¶å†è½cacheå¹¶é€šçŸ¥å…¶ä»–cacheå¤±æ•ˆï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼Œè¿™æ ·CPUå°±å¯ä»¥å‡å°‘stallç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆstore bufferåˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰ã€‚
ğŸ’¡å•æ ¸æ—¶ä¿è¯äº†ä¸€è‡´æ€§
store bufferæ˜¯ä¸ªFIFOï¼ŒåŒä¸ªcpuä¸¤ä¸ªå†™æ“ä½œä¸€å®šæ˜¯é¡ºåºæ‰§è¡Œçš„ åŒä¸ªcpuå…ˆå†™åè¯»ï¼Œä¸ä¼šå‡ºç°è¯»åˆ°æ—§æ•°æ®çš„æƒ…å†µï¼Œå› ä¸ºè¯»çš„æ—¶å€™ä¼šæ£€æŸ¥store bufferæ˜¯å¦æœ‰åŒä¸ªåœ°å€çš„å†™æ“ä½œ å¼•å…¥invalidate queue CPU cacheæ›´æ–°cachelineåï¼Œé€šçŸ¥å…¶ä»–CPUæ›´æ–°cacheï¼Œéœ€é€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼Œå¦‚MESI/MESIFæ¶ˆæ¯invalidateã€‚
æ­£å¸¸æ¥è¯´ï¼Œæ”¶åˆ°æ­¤é€šçŸ¥çš„CPUåº”ä»cacheä¸­å°†å¯¹åº”cachelineæ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†æ˜¯å¦‚æœç«‹å³æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œçš„è¯ï¼ŒCPUä¼šé¢‘ç¹è¢«é˜»æ–­æ‰§è¡Œï¼Œæ‰€ä»¥CPUä¸­å¼•å…¥äº†invalidate queueï¼Œæ”¶åˆ°invalidateé€šçŸ¥åç¼“å­˜èµ·æ¥å¹¶ç«‹å³å›å¤ACKï¼Œä½†å»¶è¿Ÿå¤„ç†ã€‚
ï¼ˆinvalidate queue åˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰
å¼•å…¥çš„é—®é¢˜ è¿™ä¹ˆè®¾è®¡å¼•å…¥çš„é—®é¢˜ï¼š
store bufferï¼šæœ¬åœ°cacheæ›´æ–°ä¸èƒ½ç«‹å³è¢«å…¶ä»–CPUæˆ–è€…CPU coreè§‚æµ‹åˆ°äº†ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼› invalidate queueï¼šæœ¬åœ°cacheæ²¡æœ‰ç«‹å³æ›´æ–°æ•°æ®ï¼Œä¸Šå±‚åº”ç”¨çœ‹ä¸åˆ°å…¶ä»–CPUæ›´æ–°çš„æ•°æ®ï¼ˆå…¶å®å°±æ˜¯ç¬¬ä¸€ç‚¹ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼‰ å¤„ç†å™¨æ‰§è¡Œæ“ä½œå˜åŒ– å¦‚æœæ²¡æœ‰store bufferã€invalidate queueï¼ŒMESIï¼Œcacheå¦‚ä½•å·¥ä½œï¼Ÿ
å½“åŒ…å«å˜é‡açš„cachelineï¼Œå…¶è¢«CPU 0å’ŒCPU 1å…±äº«ï¼Œå½“CPU 0æ›´æ–°è¯¥cachelineä¹‹åï¼Œä¼šå‘é€invalidateç»™CPU 1ï¼ŒCPU 1éšå³æŠŠå¯¹åº”çš„cachelineæ ‡è®°ä¸ºinvalidateï¼› å½“CPU 1ä¸‹æ¬¡è¯»å–å˜é‡açš„cachelineæ—¶ï¼Œå‘ç°æ ‡è®°ä¸ºäº†æ— æ•ˆï¼Œæ­¤æ—¶å‘å‡ºreadè¯·æ±‚ï¼ŒCPU 0è§‚æµ‹åˆ°è‡ªå·±è¿™è¾¹å¯¹åº”çš„cachelineæ˜¯modifiedçŠ¶æ€ï¼Œcachelineæ˜¯æœ€æ–°çš„ï¼Œæ­¤æ—¶ä¼šå°†å¯¹åº”cachelineæ•°æ®å‘é€ç»™CPU 1ï¼Œè¿™æ ·CPU 1å°±è§‚æµ‹åˆ°äº†æœ€æ–°çš„æ•°æ®ï¼› CPU 0ä¸­cachelineä½•æ—¶å†™å›ä¸»å­˜ï¼Ÿå¯èƒ½æ˜¯è¢«æ·˜æ±°çš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ«äººreadçš„æ—¶å€™ï¼Œè¿™ä¸ªæˆ‘ä»¬å…ˆä¸å…³å¿ƒã€‚ å¦‚æœå¼•å…¥äº†store bufferã€invalidate queueä¹‹åï¼Œåˆè¯¥å¦‚ä½•å·¥ä½œå‘¢ï¼Ÿ
å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†è¯¥store bufferä¸­çš„æ›´æ–°ï¼Œé€šçŸ¥åˆ°å…¶ä»–CPUï¼Œè¿™å°±æ˜¯write barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 0æ‰§è¡Œï¼Œå¹¶å°†CPU 0æŠŠstore bufferä¸­è®°å½•çš„ä¸€äº›æ›´æ–°åº”ç”¨åˆ°cacheä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘cacheä¸€è‡´æ€§åè®®MESIé€šçŸ¥CPU 1 cacheline invalidateï¼› å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†CPU 1ä¸­invalidate queueè®°å½•ä¸‹æ¥çš„invalidateå¯¹åº”çš„cachelineåŠæ—¶æ¸…ç†æ‰ï¼Œè¿™å°±æ˜¯read barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 1æ‰§è¡Œï¼Œå°†å…¶invalidate queueä¸­çš„æ¯ä¸ªinvalidateè¯·æ±‚å¯¹åº”çš„cachelineå…¨éƒ¨æ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸‹æ¬¡è¯»å–æ—¶ä»å†…å­˜æˆ–è€…CPU 0è¯»å–æœ€æ–°æ•°æ®ï¼› å†…å­˜å±éšœ è¿™é‡Œçš„è¯»å†™å±éšœè¦ä¾èµ–å¤„ç†å™¨æä¾›çš„å±éšœæŒ‡ä»¤ åœ¨å±éšœæŒ‡ä»¤ä¹‹ä¸Šï¼Œå†…æ ¸å¯ä»¥æŒ‰éœ€é€‰æ‹©ï¼Œå¦‚Linuxåœ¨x86å¹³å°é€‰æ‹©ç”¨ lock; addlæ¥å®ç°è¯»å†™å±éšœ smp_mb/smp_rmb/smp_wmbï¼Œx86å…¶å®ä¹Ÿæä¾›äº†mfenceã€lfenceã€sfenceã€‚è‡³äºLinuxä¸ºä»€ä¹ˆè¿™ä¹ˆé€‰æ‹©ï¼Œåº”è¯¥æ˜¯è·Ÿx86å®ç°æœ‰å…³ç³»ï¼Œä¸€æ¡æŒ‡ä»¤ lock;addlåŒæ—¶å®ç°å…¨å±éšœ/è¯»å±éšœ/å†™å±éšœè¶³çŸ£ã€‚ å…¶ä»–ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹ï¼Œé€šå¸¸ä¼šå®šä¹‰ä¸€äº›Happens-Beforeå…³ç³»ï¼Œè¿™é‡Œé¢å°±éšå«äº†å„ç§å±éšœçš„åº”ç”¨ã€‚åŸºäºå±éšœå®ç°çš„å„ç§åŒæ­¥åŸè¯­å¦‚mutexã€semaphoreç­‰å°±æ¯”è¾ƒå¸¸è§äº† å†™æ“ä½œååŠ å…¥å†™å±éšœï¼Œå°±ä¼šåˆ·æ–°è¯¥cpuçš„æ‰€æœ‰store bufferï¼Œåˆ·åˆ°å…¶ä»–cpuçš„invaliate queue è¯»æ“ä½œå‰åŠ å…¥è¯»å±éšœï¼Œå°±ä¼šæ¶ˆè´¹å½“å‰cpuçš„æ‰€æœ‰invalidate DeepSeek-R1å¯¹æ¼”è¿›å²çš„æ¢³ç† å¸®æˆ‘è¿™ä¸ªç¬”è®°åšä¸‹è¡¥å……ï¼Œä¾‹å¦‚å±•å¼€è¯´è¯´æ¼”è¿›çš„å†å²ï¼ˆç»“åˆæ—¶é—´ï¼‰ï¼Œæ›´å…·ä½“çš„ä¾‹å­ç­‰ç­‰ cpu-memoryå¾ˆæ…¢ï¼Œå¼•å…¥cache ç”±äºæ¯ä¸ªcpuéƒ½æœ‰å„è‡ªçš„cacheï¼Œä¿®æ”¹æ—¶éœ€è¦ä¿è¯å…¶ä»–ç¼“å­˜å¤±æ•ˆï¼Œæ”¶åˆ°ackåæ‰èƒ½ç»§ç»­ä¿®æ”¹ å¼•å…¥ä¸¤ä¸ªé˜Ÿåˆ— Store Bufferï¼šç”¨äºæå‡å†™æ“ä½œçš„æ€§èƒ½ã€‚æ›´æ–°å†…å­˜æ—¶ï¼Œç›´æ¥æ‰”åˆ°bufferä¸­ï¼Œå¼‚æ­¥æ›´æ–°ã€‚bufferæ‰§è¡Œæ›´æ–°æ—¶ï¼Œä¹Ÿä¸€æ ·æ˜¯æ”¶åˆ°å…¶ä»–cpuçš„ç¼“å­˜å¤±æ•ˆackåæ‰èƒ½ä¿®æ”¹ã€ç®€è€Œè¨€ä¹‹ï¼ŒStore Buffer å°±åƒä¸€ä¸ª â€œå†™æ“ä½œç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥ â€œå…ˆå†™å…ˆèµ°â€ï¼Œä»è€Œé¿å…å†™æ“ä½œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ã€‘ Invalid Queue: Invalidation Queue çš„ä½œç”¨å°±æ˜¯å¼‚æ­¥åœ°æ¥æ”¶å’Œå¤„ç†è¿™äº›æ¥è‡ªå…¶ä»– CPU Core çš„ Invalidate Requestã€‚ å½“ CPU Core (ä¾‹å¦‚ CPU1) æ”¶åˆ°æ¥è‡ª CPU0 çš„ Invalidate Request æ—¶ï¼Œå®ƒä¸ä¼šç«‹å³æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå»åŒæ­¥å¤„ç†ç¼“å­˜å¤±æ•ˆã€‚ ç›¸åï¼Œå®ƒä¼šå°†æ”¶åˆ°çš„ Invalidate Request å…ˆæ”¾å…¥ Invalidation Queue ä¸­æ’é˜Ÿã€‚ CPU Core å¯ä»¥ç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ï¼Œè€Œ Invalidation Queue ä¼šåœ¨ åå°å¼‚æ­¥åœ° ä»é˜Ÿåˆ—ä¸­å–å‡º Invalidate Requestï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ç¼“å­˜å¤±æ•ˆæ“ä½œ (ä¾‹å¦‚ï¼Œæ ‡è®° Cache Line ä¸º Invalid)ã€‚ã€ç®€è€Œè¨€ä¹‹ï¼ŒInvalidation Queue å°±åƒä¸€ä¸ª â€œå¤±æ•ˆè¯·æ±‚ç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥å¼‚æ­¥åœ°å¤„ç†æ¥è‡ªå…¶ä»– Core çš„å¤±æ•ˆè¯·æ±‚ï¼Œé¿å…å› ç­‰å¾…å¤±æ•ˆå¤„ç†è€Œé˜»å¡ CPU çš„æ­£å¸¸æ‰§è¡Œã€‚ã€‘ æœ€åçš„æ€»ç»“å¾ˆå¥½ï¼šcache-&amp;gt;mesi-&amp;gt;two queue-&amp;gt;barrierçš„æ¼”è¿› å¥½çš„ï¼æˆ‘å°†ç»“åˆæ—¶é—´çº¿ã€å…·ä½“æ¡ˆä¾‹å’ŒæŠ€æœ¯ç»†èŠ‚ï¼Œè¡¥å……å¹¶æ‰©å±•æ‚¨çš„ç¬”è®°å†…å®¹ï¼š" />
  <meta name="description" content="å‚è€ƒ Lockså®ç°:èƒŒåä¸ä¸ºäººçŸ¥çš„æ•…äº‹ - MySpace
ä»¥åŠä¸‹é¢ä¸¤ä¸ªè§†é¢‘å¾ˆæ¸…æ¥šè§£é‡Šäº†cpu cache,MESI, store buffer/invalidation queue, å†…å­˜å±éšœçš„å†å²æ¼”è¿›
ã€é¢è¯•å®˜é—®æˆ‘MESIå¦‚ä½•ä¿è¯å†…å­˜ä¸€è‡´æ€§ï¼Œæˆ‘æŠŠè¿™ä¸ªåŠ¨ç”»ç”©ç»™ä»–ã€‘ https://www.bilibili.com/video/BV1kD4y1T7XU/?share_source=copy_web&amp;amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de ã€ç¾å›¢ä¸€é¢é—®æˆ‘å†…å­˜å±éšœå’Œvolatileçš„å…³ç³»ï¼Œæˆ‘è¯´äº†20åˆ†é’Ÿã€‘ https://www.bilibili.com/video/BV1cT411a7Sn/?share_source=copy_web&amp;amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de å¤šä¸ªCPUæˆ–CPU Coreä¹‹é—´é€šè¿‡æ€»çº¿è¿æ¥ï¼› CPUé€šè¿‡æ€»çº¿ä¸ä¸»å­˜ï¼ˆmemoryï¼‰è¿æ¥ï¼› æ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„æœ¬åœ°cacheï¼Œé€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼ˆå¦‚MESI/MESIFï¼‰ä¸å…¶ä»–CPU Coreç»´æŠ¤ä¸€ä¸ªä¸€è‡´çš„æ•°æ®è§†å›¾ï¼› å¼•å…¥store buffer CPUå¯¹cachelineçš„ä¿®æ”¹ï¼Œè‹¥ç›´æ¥è½cacheï¼Œä¸€è‡´æ€§åè®®ä¼šå¼•å…¥ä¸å°çš„å¼€é”€ï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼ŒCPUä¼šstallæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸ºäº†æé«˜æŒ‡ä»¤ååï¼Œè¿™é‡Œå¼•å…¥äº†store bufferã€‚
æ•°æ®æ›´æ–°ä¸ç›´æ¥å†™cachelineè€Œæ˜¯å…ˆå†™åˆ°store bufferï¼Œåé¢éœ€è¦æ—¶å†è½cacheå¹¶é€šçŸ¥å…¶ä»–cacheå¤±æ•ˆï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼Œè¿™æ ·CPUå°±å¯ä»¥å‡å°‘stallç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆstore bufferåˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰ã€‚
ğŸ’¡å•æ ¸æ—¶ä¿è¯äº†ä¸€è‡´æ€§
store bufferæ˜¯ä¸ªFIFOï¼ŒåŒä¸ªcpuä¸¤ä¸ªå†™æ“ä½œä¸€å®šæ˜¯é¡ºåºæ‰§è¡Œçš„ åŒä¸ªcpuå…ˆå†™åè¯»ï¼Œä¸ä¼šå‡ºç°è¯»åˆ°æ—§æ•°æ®çš„æƒ…å†µï¼Œå› ä¸ºè¯»çš„æ—¶å€™ä¼šæ£€æŸ¥store bufferæ˜¯å¦æœ‰åŒä¸ªåœ°å€çš„å†™æ“ä½œ å¼•å…¥invalidate queue CPU cacheæ›´æ–°cachelineåï¼Œé€šçŸ¥å…¶ä»–CPUæ›´æ–°cacheï¼Œéœ€é€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼Œå¦‚MESI/MESIFæ¶ˆæ¯invalidateã€‚
æ­£å¸¸æ¥è¯´ï¼Œæ”¶åˆ°æ­¤é€šçŸ¥çš„CPUåº”ä»cacheä¸­å°†å¯¹åº”cachelineæ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†æ˜¯å¦‚æœç«‹å³æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œçš„è¯ï¼ŒCPUä¼šé¢‘ç¹è¢«é˜»æ–­æ‰§è¡Œï¼Œæ‰€ä»¥CPUä¸­å¼•å…¥äº†invalidate queueï¼Œæ”¶åˆ°invalidateé€šçŸ¥åç¼“å­˜èµ·æ¥å¹¶ç«‹å³å›å¤ACKï¼Œä½†å»¶è¿Ÿå¤„ç†ã€‚
ï¼ˆinvalidate queue åˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰
å¼•å…¥çš„é—®é¢˜ è¿™ä¹ˆè®¾è®¡å¼•å…¥çš„é—®é¢˜ï¼š
store bufferï¼šæœ¬åœ°cacheæ›´æ–°ä¸èƒ½ç«‹å³è¢«å…¶ä»–CPUæˆ–è€…CPU coreè§‚æµ‹åˆ°äº†ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼› invalidate queueï¼šæœ¬åœ°cacheæ²¡æœ‰ç«‹å³æ›´æ–°æ•°æ®ï¼Œä¸Šå±‚åº”ç”¨çœ‹ä¸åˆ°å…¶ä»–CPUæ›´æ–°çš„æ•°æ®ï¼ˆå…¶å®å°±æ˜¯ç¬¬ä¸€ç‚¹ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼‰ å¤„ç†å™¨æ‰§è¡Œæ“ä½œå˜åŒ– å¦‚æœæ²¡æœ‰store bufferã€invalidate queueï¼ŒMESIï¼Œcacheå¦‚ä½•å·¥ä½œï¼Ÿ
å½“åŒ…å«å˜é‡açš„cachelineï¼Œå…¶è¢«CPU 0å’ŒCPU 1å…±äº«ï¼Œå½“CPU 0æ›´æ–°è¯¥cachelineä¹‹åï¼Œä¼šå‘é€invalidateç»™CPU 1ï¼ŒCPU 1éšå³æŠŠå¯¹åº”çš„cachelineæ ‡è®°ä¸ºinvalidateï¼› å½“CPU 1ä¸‹æ¬¡è¯»å–å˜é‡açš„cachelineæ—¶ï¼Œå‘ç°æ ‡è®°ä¸ºäº†æ— æ•ˆï¼Œæ­¤æ—¶å‘å‡ºreadè¯·æ±‚ï¼ŒCPU 0è§‚æµ‹åˆ°è‡ªå·±è¿™è¾¹å¯¹åº”çš„cachelineæ˜¯modifiedçŠ¶æ€ï¼Œcachelineæ˜¯æœ€æ–°çš„ï¼Œæ­¤æ—¶ä¼šå°†å¯¹åº”cachelineæ•°æ®å‘é€ç»™CPU 1ï¼Œè¿™æ ·CPU 1å°±è§‚æµ‹åˆ°äº†æœ€æ–°çš„æ•°æ®ï¼› CPU 0ä¸­cachelineä½•æ—¶å†™å›ä¸»å­˜ï¼Ÿå¯èƒ½æ˜¯è¢«æ·˜æ±°çš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ«äººreadçš„æ—¶å€™ï¼Œè¿™ä¸ªæˆ‘ä»¬å…ˆä¸å…³å¿ƒã€‚ å¦‚æœå¼•å…¥äº†store bufferã€invalidate queueä¹‹åï¼Œåˆè¯¥å¦‚ä½•å·¥ä½œå‘¢ï¼Ÿ
å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†è¯¥store bufferä¸­çš„æ›´æ–°ï¼Œé€šçŸ¥åˆ°å…¶ä»–CPUï¼Œè¿™å°±æ˜¯write barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 0æ‰§è¡Œï¼Œå¹¶å°†CPU 0æŠŠstore bufferä¸­è®°å½•çš„ä¸€äº›æ›´æ–°åº”ç”¨åˆ°cacheä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘cacheä¸€è‡´æ€§åè®®MESIé€šçŸ¥CPU 1 cacheline invalidateï¼› å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†CPU 1ä¸­invalidate queueè®°å½•ä¸‹æ¥çš„invalidateå¯¹åº”çš„cachelineåŠæ—¶æ¸…ç†æ‰ï¼Œè¿™å°±æ˜¯read barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 1æ‰§è¡Œï¼Œå°†å…¶invalidate queueä¸­çš„æ¯ä¸ªinvalidateè¯·æ±‚å¯¹åº”çš„cachelineå…¨éƒ¨æ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸‹æ¬¡è¯»å–æ—¶ä»å†…å­˜æˆ–è€…CPU 0è¯»å–æœ€æ–°æ•°æ®ï¼› å†…å­˜å±éšœ è¿™é‡Œçš„è¯»å†™å±éšœè¦ä¾èµ–å¤„ç†å™¨æä¾›çš„å±éšœæŒ‡ä»¤ åœ¨å±éšœæŒ‡ä»¤ä¹‹ä¸Šï¼Œå†…æ ¸å¯ä»¥æŒ‰éœ€é€‰æ‹©ï¼Œå¦‚Linuxåœ¨x86å¹³å°é€‰æ‹©ç”¨ lock; addlæ¥å®ç°è¯»å†™å±éšœ smp_mb/smp_rmb/smp_wmbï¼Œx86å…¶å®ä¹Ÿæä¾›äº†mfenceã€lfenceã€sfenceã€‚è‡³äºLinuxä¸ºä»€ä¹ˆè¿™ä¹ˆé€‰æ‹©ï¼Œåº”è¯¥æ˜¯è·Ÿx86å®ç°æœ‰å…³ç³»ï¼Œä¸€æ¡æŒ‡ä»¤ lock;addlåŒæ—¶å®ç°å…¨å±éšœ/è¯»å±éšœ/å†™å±éšœè¶³çŸ£ã€‚ å…¶ä»–ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹ï¼Œé€šå¸¸ä¼šå®šä¹‰ä¸€äº›Happens-Beforeå…³ç³»ï¼Œè¿™é‡Œé¢å°±éšå«äº†å„ç§å±éšœçš„åº”ç”¨ã€‚åŸºäºå±éšœå®ç°çš„å„ç§åŒæ­¥åŸè¯­å¦‚mutexã€semaphoreç­‰å°±æ¯”è¾ƒå¸¸è§äº† å†™æ“ä½œååŠ å…¥å†™å±éšœï¼Œå°±ä¼šåˆ·æ–°è¯¥cpuçš„æ‰€æœ‰store bufferï¼Œåˆ·åˆ°å…¶ä»–cpuçš„invaliate queue è¯»æ“ä½œå‰åŠ å…¥è¯»å±éšœï¼Œå°±ä¼šæ¶ˆè´¹å½“å‰cpuçš„æ‰€æœ‰invalidate DeepSeek-R1å¯¹æ¼”è¿›å²çš„æ¢³ç† å¸®æˆ‘è¿™ä¸ªç¬”è®°åšä¸‹è¡¥å……ï¼Œä¾‹å¦‚å±•å¼€è¯´è¯´æ¼”è¿›çš„å†å²ï¼ˆç»“åˆæ—¶é—´ï¼‰ï¼Œæ›´å…·ä½“çš„ä¾‹å­ç­‰ç­‰ cpu-memoryå¾ˆæ…¢ï¼Œå¼•å…¥cache ç”±äºæ¯ä¸ªcpuéƒ½æœ‰å„è‡ªçš„cacheï¼Œä¿®æ”¹æ—¶éœ€è¦ä¿è¯å…¶ä»–ç¼“å­˜å¤±æ•ˆï¼Œæ”¶åˆ°ackåæ‰èƒ½ç»§ç»­ä¿®æ”¹ å¼•å…¥ä¸¤ä¸ªé˜Ÿåˆ— Store Bufferï¼šç”¨äºæå‡å†™æ“ä½œçš„æ€§èƒ½ã€‚æ›´æ–°å†…å­˜æ—¶ï¼Œç›´æ¥æ‰”åˆ°bufferä¸­ï¼Œå¼‚æ­¥æ›´æ–°ã€‚bufferæ‰§è¡Œæ›´æ–°æ—¶ï¼Œä¹Ÿä¸€æ ·æ˜¯æ”¶åˆ°å…¶ä»–cpuçš„ç¼“å­˜å¤±æ•ˆackåæ‰èƒ½ä¿®æ”¹ã€ç®€è€Œè¨€ä¹‹ï¼ŒStore Buffer å°±åƒä¸€ä¸ª â€œå†™æ“ä½œç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥ â€œå…ˆå†™å…ˆèµ°â€ï¼Œä»è€Œé¿å…å†™æ“ä½œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ã€‘ Invalid Queue: Invalidation Queue çš„ä½œç”¨å°±æ˜¯å¼‚æ­¥åœ°æ¥æ”¶å’Œå¤„ç†è¿™äº›æ¥è‡ªå…¶ä»– CPU Core çš„ Invalidate Requestã€‚ å½“ CPU Core (ä¾‹å¦‚ CPU1) æ”¶åˆ°æ¥è‡ª CPU0 çš„ Invalidate Request æ—¶ï¼Œå®ƒä¸ä¼šç«‹å³æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå»åŒæ­¥å¤„ç†ç¼“å­˜å¤±æ•ˆã€‚ ç›¸åï¼Œå®ƒä¼šå°†æ”¶åˆ°çš„ Invalidate Request å…ˆæ”¾å…¥ Invalidation Queue ä¸­æ’é˜Ÿã€‚ CPU Core å¯ä»¥ç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ï¼Œè€Œ Invalidation Queue ä¼šåœ¨ åå°å¼‚æ­¥åœ° ä»é˜Ÿåˆ—ä¸­å–å‡º Invalidate Requestï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ç¼“å­˜å¤±æ•ˆæ“ä½œ (ä¾‹å¦‚ï¼Œæ ‡è®° Cache Line ä¸º Invalid)ã€‚ã€ç®€è€Œè¨€ä¹‹ï¼ŒInvalidation Queue å°±åƒä¸€ä¸ª â€œå¤±æ•ˆè¯·æ±‚ç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥å¼‚æ­¥åœ°å¤„ç†æ¥è‡ªå…¶ä»– Core çš„å¤±æ•ˆè¯·æ±‚ï¼Œé¿å…å› ç­‰å¾…å¤±æ•ˆå¤„ç†è€Œé˜»å¡ CPU çš„æ­£å¸¸æ‰§è¡Œã€‚ã€‘ æœ€åçš„æ€»ç»“å¾ˆå¥½ï¼šcache-&amp;gt;mesi-&amp;gt;two queue-&amp;gt;barrierçš„æ¼”è¿› å¥½çš„ï¼æˆ‘å°†ç»“åˆæ—¶é—´çº¿ã€å…·ä½“æ¡ˆä¾‹å’ŒæŠ€æœ¯ç»†èŠ‚ï¼Œè¡¥å……å¹¶æ‰©å±•æ‚¨çš„ç¬”è®°å†…å®¹ï¼š" />
  <meta property="og:locale" content="zh" /><meta property="og:image" content="" />
  

  
    <style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 1em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}</style>
  
  
    <style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style>
  

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="XKJ Blog">
  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel="stylesheet">
  
  

  
  
</head>


<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="header-title">
    <a href="/"
      >Kaijian Xu</a
    >
  </div>
  <div class="header-subtitle"></div>
</header>
<div class="row end-md center-xs header-items">
  
</div>
<div class="row end-xs">
   
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">å†…å­˜å±éšœçš„å‰ä¸–ä»Šç”Ÿ</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2025-02-19 00:00:00 UTC">
                19 Feb 2025
              </time>
              
            </div>
            <div class="col-xs-6">
              
              <div class="post-author">
                <a target="_blank" href="">@Kaijian Xu</a>
              </div>
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <p>å‚è€ƒ <a href="https://www.hitzhangjie.pro/blog/2021-04-17-locks%E5%AE%9E%E7%8E%B0%E9%82%A3%E4%BA%9B%E4%B8%8D%E4%B8%BA%E4%BA%BA%E7%9F%A5%E7%9A%84%E6%95%85%E4%BA%8B/">Lockså®ç°:èƒŒåä¸ä¸ºäººçŸ¥çš„æ•…äº‹ - MySpace</a></p>
<p>ä»¥åŠä¸‹é¢ä¸¤ä¸ªè§†é¢‘å¾ˆæ¸…æ¥šè§£é‡Šäº†cpu cache,MESI, store buffer/invalidation queue, å†…å­˜å±éšœçš„å†å²æ¼”è¿›</p>
<ul>
<li>ã€é¢è¯•å®˜é—®æˆ‘MESIå¦‚ä½•ä¿è¯å†…å­˜ä¸€è‡´æ€§ï¼Œæˆ‘æŠŠè¿™ä¸ªåŠ¨ç”»ç”©ç»™ä»–ã€‘ <a href="https://www.bilibili.com/video/BV1kD4y1T7XU/?share_source=copy_web&amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de">https://www.bilibili.com/video/BV1kD4y1T7XU/?share_source=copy_web&amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de</a></li>
<li>ã€ç¾å›¢ä¸€é¢é—®æˆ‘å†…å­˜å±éšœå’Œvolatileçš„å…³ç³»ï¼Œæˆ‘è¯´äº†20åˆ†é’Ÿã€‘ <a href="https://www.bilibili.com/video/BV1cT411a7Sn/?share_source=copy_web&amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de">https://www.bilibili.com/video/BV1cT411a7Sn/?share_source=copy_web&amp;vd_source=6d5bbefdbb303f5c1b77aaeaa935d3de</a></li>
</ul>
<p><img src="https://kkbabe-picgo.oss-cn-hangzhou.aliyuncs.com/img/20250219215829.png" alt="image.png"></p>
<ul>
<li>å¤šä¸ªCPUæˆ–CPU Coreä¹‹é—´é€šè¿‡æ€»çº¿è¿æ¥ï¼›</li>
<li>CPUé€šè¿‡æ€»çº¿ä¸ä¸»å­˜ï¼ˆmemoryï¼‰è¿æ¥ï¼›</li>
<li>æ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„æœ¬åœ°cacheï¼Œé€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼ˆå¦‚MESI/MESIFï¼‰ä¸å…¶ä»–CPU Coreç»´æŠ¤ä¸€ä¸ªä¸€è‡´çš„æ•°æ®è§†å›¾ï¼›</li>
</ul>
<h3 id="å¼•å…¥store-buffer">å¼•å…¥store buffer</h3>
<p>CPUå¯¹cachelineçš„ä¿®æ”¹ï¼Œè‹¥ç›´æ¥è½cacheï¼Œä¸€è‡´æ€§åè®®ä¼šå¼•å…¥ä¸å°çš„å¼€é”€ï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼ŒCPUä¼šstallæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸ºäº†æé«˜æŒ‡ä»¤ååï¼Œè¿™é‡Œå¼•å…¥äº†store bufferã€‚</p>
<p>æ•°æ®æ›´æ–°ä¸ç›´æ¥å†™cachelineè€Œæ˜¯å…ˆå†™åˆ°store bufferï¼Œåé¢éœ€è¦æ—¶å†<strong>è½cache</strong>å¹¶<strong>é€šçŸ¥å…¶ä»–cacheå¤±æ•ˆ</strong>ï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼Œè¿™æ ·CPUå°±å¯ä»¥å‡å°‘stallç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆstore bufferåˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰ã€‚</p>
<p><img src="https://kkbabe-picgo.oss-cn-hangzhou.aliyuncs.com/img/cpu2.png" alt="cpu2"></p>
<p>ğŸ’¡å•æ ¸æ—¶ä¿è¯äº†ä¸€è‡´æ€§</p>
<ol>
<li>store bufferæ˜¯ä¸ªFIFOï¼ŒåŒä¸ªcpuä¸¤ä¸ªå†™æ“ä½œä¸€å®šæ˜¯é¡ºåºæ‰§è¡Œçš„</li>
<li>åŒä¸ªcpuå…ˆå†™åè¯»ï¼Œä¸ä¼šå‡ºç°è¯»åˆ°æ—§æ•°æ®çš„æƒ…å†µï¼Œå› ä¸ºè¯»çš„æ—¶å€™ä¼šæ£€æŸ¥store bufferæ˜¯å¦æœ‰åŒä¸ªåœ°å€çš„å†™æ“ä½œ</li>
</ol>
<h3 id="å¼•å…¥invalidate-queue">å¼•å…¥invalidate queue</h3>
<p>CPU cacheæ›´æ–°cachelineåï¼Œé€šçŸ¥å…¶ä»–CPUæ›´æ–°cacheï¼Œéœ€é€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼Œå¦‚MESI/MESIFæ¶ˆæ¯invalidateã€‚</p>
<p>æ­£å¸¸æ¥è¯´ï¼Œæ”¶åˆ°æ­¤é€šçŸ¥çš„CPUåº”ä»cacheä¸­å°†å¯¹åº”cachelineæ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†æ˜¯å¦‚æœç«‹å³æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œçš„è¯ï¼ŒCPUä¼šé¢‘ç¹è¢«é˜»æ–­æ‰§è¡Œï¼Œæ‰€ä»¥CPUä¸­å¼•å…¥äº†invalidate queueï¼Œæ”¶åˆ°invalidateé€šçŸ¥åç¼“å­˜èµ·æ¥å¹¶ç«‹å³å›å¤ACKï¼Œä½†å»¶è¿Ÿå¤„ç†ã€‚</p>
<p>ï¼ˆinvalidate queue åˆ·æ–°è¿‡ç¨‹ä¸éœ€è¦cpuå‚ä¸ï¼‰</p>
<h3 id="å¼•å…¥çš„é—®é¢˜">å¼•å…¥çš„é—®é¢˜</h3>
<p>è¿™ä¹ˆè®¾è®¡å¼•å…¥çš„é—®é¢˜ï¼š</p>
<ul>
<li>store bufferï¼šæœ¬åœ°cacheæ›´æ–°ä¸èƒ½ç«‹å³è¢«å…¶ä»–CPUæˆ–è€…CPU coreè§‚æµ‹åˆ°äº†ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼›</li>
<li>invalidate queueï¼šæœ¬åœ°cacheæ²¡æœ‰ç«‹å³æ›´æ–°æ•°æ®ï¼Œä¸Šå±‚åº”ç”¨çœ‹ä¸åˆ°å…¶ä»–CPUæ›´æ–°çš„æ•°æ®ï¼ˆå…¶å®å°±æ˜¯ç¬¬ä¸€ç‚¹ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼‰</li>
</ul>
<h3 id="å¤„ç†å™¨æ‰§è¡Œæ“ä½œå˜åŒ–">å¤„ç†å™¨æ‰§è¡Œæ“ä½œå˜åŒ–</h3>
<p><strong>å¦‚æœæ²¡æœ‰store bufferã€invalidate queueï¼ŒMESIï¼Œcacheå¦‚ä½•å·¥ä½œï¼Ÿ</strong></p>
<ul>
<li>å½“åŒ…å«å˜é‡açš„cachelineï¼Œå…¶è¢«CPU 0å’ŒCPU 1å…±äº«ï¼Œå½“CPU 0æ›´æ–°è¯¥cachelineä¹‹åï¼Œä¼šå‘é€invalidateç»™CPU 1ï¼ŒCPU 1éšå³æŠŠå¯¹åº”çš„cachelineæ ‡è®°ä¸ºinvalidateï¼›</li>
<li>å½“CPU 1ä¸‹æ¬¡è¯»å–å˜é‡açš„cachelineæ—¶ï¼Œå‘ç°æ ‡è®°ä¸ºäº†æ— æ•ˆï¼Œæ­¤æ—¶å‘å‡ºreadè¯·æ±‚ï¼ŒCPU 0è§‚æµ‹åˆ°è‡ªå·±è¿™è¾¹å¯¹åº”çš„cachelineæ˜¯modifiedçŠ¶æ€ï¼Œcachelineæ˜¯æœ€æ–°çš„ï¼Œæ­¤æ—¶ä¼šå°†å¯¹åº”cachelineæ•°æ®å‘é€ç»™CPU 1ï¼Œè¿™æ ·CPU 1å°±è§‚æµ‹åˆ°äº†æœ€æ–°çš„æ•°æ®ï¼›</li>
<li>CPU 0ä¸­cachelineä½•æ—¶å†™å›ä¸»å­˜ï¼Ÿå¯èƒ½æ˜¯è¢«æ·˜æ±°çš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ«äººreadçš„æ—¶å€™ï¼Œè¿™ä¸ªæˆ‘ä»¬å…ˆä¸å…³å¿ƒã€‚</li>
</ul>
<p><strong>å¦‚æœå¼•å…¥äº†store bufferã€invalidate queueä¹‹åï¼Œåˆè¯¥å¦‚ä½•å·¥ä½œå‘¢ï¼Ÿ</strong></p>
<ul>
<li>å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†è¯¥store bufferä¸­çš„æ›´æ–°ï¼Œé€šçŸ¥åˆ°å…¶ä»–CPUï¼Œè¿™å°±æ˜¯write barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 0æ‰§è¡Œï¼Œå¹¶å°†CPU 0æŠŠstore bufferä¸­è®°å½•çš„ä¸€äº›æ›´æ–°åº”ç”¨åˆ°cacheä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘cacheä¸€è‡´æ€§åè®®MESIé€šçŸ¥CPU 1 cacheline invalidateï¼›</li>
<li>å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†CPU 1ä¸­invalidate queueè®°å½•ä¸‹æ¥çš„invalidateå¯¹åº”çš„cachelineåŠæ—¶æ¸…ç†æ‰ï¼Œè¿™å°±æ˜¯read barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 1æ‰§è¡Œï¼Œå°†å…¶invalidate queueä¸­çš„æ¯ä¸ªinvalidateè¯·æ±‚å¯¹åº”çš„cachelineå…¨éƒ¨æ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸‹æ¬¡è¯»å–æ—¶ä»å†…å­˜æˆ–è€…CPU 0è¯»å–æœ€æ–°æ•°æ®ï¼›</li>
</ul>
<h3 id="å†…å­˜å±éšœ">å†…å­˜å±éšœ</h3>
<ul>
<li>è¿™é‡Œçš„è¯»å†™å±éšœè¦ä¾èµ–å¤„ç†å™¨æä¾›çš„å±éšœæŒ‡ä»¤</li>
<li>åœ¨å±éšœæŒ‡ä»¤ä¹‹ä¸Šï¼Œå†…æ ¸å¯ä»¥æŒ‰éœ€é€‰æ‹©ï¼Œå¦‚Linuxåœ¨x86å¹³å°é€‰æ‹©ç”¨ <code>lock; addl</code>æ¥å®ç°è¯»å†™å±éšœ smp_mb/smp_rmb/smp_wmbï¼Œx86å…¶å®ä¹Ÿæä¾›äº†mfenceã€lfenceã€sfenceã€‚è‡³äºLinuxä¸ºä»€ä¹ˆè¿™ä¹ˆé€‰æ‹©ï¼Œåº”è¯¥æ˜¯è·Ÿx86å®ç°æœ‰å…³ç³»ï¼Œä¸€æ¡æŒ‡ä»¤ <code>lock;addl</code>åŒæ—¶å®ç°å…¨å±éšœ/è¯»å±éšœ/å†™å±éšœè¶³çŸ£ã€‚</li>
<li>å…¶ä»–ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹ï¼Œé€šå¸¸ä¼šå®šä¹‰ä¸€äº›Happens-Beforeå…³ç³»ï¼Œè¿™é‡Œé¢å°±éšå«äº†å„ç§å±éšœçš„åº”ç”¨ã€‚åŸºäºå±éšœå®ç°çš„å„ç§åŒæ­¥åŸè¯­å¦‚mutexã€semaphoreç­‰å°±æ¯”è¾ƒå¸¸è§äº†</li>
</ul>
<p><img src="https://kkbabe-picgo.oss-cn-hangzhou.aliyuncs.com/img/image-20250219224237737.png" alt="image-20250219224237737"></p>
<ol>
<li>å†™æ“ä½œååŠ å…¥å†™å±éšœï¼Œå°±ä¼šåˆ·æ–°è¯¥cpuçš„æ‰€æœ‰store bufferï¼Œåˆ·åˆ°å…¶ä»–cpuçš„invaliate queue</li>
<li>è¯»æ“ä½œå‰åŠ å…¥è¯»å±éšœï¼Œå°±ä¼šæ¶ˆè´¹å½“å‰cpuçš„æ‰€æœ‰invalidate</li>
</ol>
<h2 id="deepseek-r1å¯¹æ¼”è¿›å²çš„æ¢³ç†">DeepSeek-R1å¯¹æ¼”è¿›å²çš„æ¢³ç†</h2>
<pre tabindex="0"><code>å¸®æˆ‘è¿™ä¸ªç¬”è®°åšä¸‹è¡¥å……ï¼Œä¾‹å¦‚å±•å¼€è¯´è¯´æ¼”è¿›çš„å†å²ï¼ˆç»“åˆæ—¶é—´ï¼‰ï¼Œæ›´å…·ä½“çš„ä¾‹å­ç­‰ç­‰

cpu-memoryå¾ˆæ…¢ï¼Œå¼•å…¥cache
ç”±äºæ¯ä¸ªcpuéƒ½æœ‰å„è‡ªçš„cacheï¼Œä¿®æ”¹æ—¶éœ€è¦ä¿è¯å…¶ä»–ç¼“å­˜å¤±æ•ˆï¼Œæ”¶åˆ°ackåæ‰èƒ½ç»§ç»­ä¿®æ”¹
å¼•å…¥ä¸¤ä¸ªé˜Ÿåˆ—
Store Bufferï¼šç”¨äºæå‡å†™æ“ä½œçš„æ€§èƒ½ã€‚æ›´æ–°å†…å­˜æ—¶ï¼Œç›´æ¥æ‰”åˆ°bufferä¸­ï¼Œå¼‚æ­¥æ›´æ–°ã€‚bufferæ‰§è¡Œæ›´æ–°æ—¶ï¼Œä¹Ÿä¸€æ ·æ˜¯æ”¶åˆ°å…¶ä»–cpuçš„ç¼“å­˜å¤±æ•ˆackåæ‰èƒ½ä¿®æ”¹ã€ç®€è€Œè¨€ä¹‹ï¼ŒStore Buffer å°±åƒä¸€ä¸ª â€œå†™æ“ä½œç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥ â€œå…ˆå†™å…ˆèµ°â€ï¼Œä»è€Œé¿å…å†™æ“ä½œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ã€‘
Invalid Queue: Invalidation Queue çš„ä½œç”¨å°±æ˜¯å¼‚æ­¥åœ°æ¥æ”¶å’Œå¤„ç†è¿™äº›æ¥è‡ªå…¶ä»– CPU Core çš„ Invalidate Requestã€‚ å½“ CPU Core (ä¾‹å¦‚ CPU1) æ”¶åˆ°æ¥è‡ª CPU0 çš„ Invalidate Request æ—¶ï¼Œå®ƒä¸ä¼šç«‹å³æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå»åŒæ­¥å¤„ç†ç¼“å­˜å¤±æ•ˆã€‚ ç›¸åï¼Œå®ƒä¼šå°†æ”¶åˆ°çš„ Invalidate Request å…ˆæ”¾å…¥ Invalidation Queue ä¸­æ’é˜Ÿã€‚ CPU Core å¯ä»¥ç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ï¼Œè€Œ Invalidation Queue ä¼šåœ¨ åå°å¼‚æ­¥åœ° ä»é˜Ÿåˆ—ä¸­å–å‡º Invalidate Requestï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ç¼“å­˜å¤±æ•ˆæ“ä½œ (ä¾‹å¦‚ï¼Œæ ‡è®° Cache Line ä¸º Invalid)ã€‚ã€ç®€è€Œè¨€ä¹‹ï¼ŒInvalidation Queue å°±åƒä¸€ä¸ª â€œå¤±æ•ˆè¯·æ±‚ç¼“å†²åŒºâ€ï¼Œè®© CPU å¯ä»¥å¼‚æ­¥åœ°å¤„ç†æ¥è‡ªå…¶ä»– Core çš„å¤±æ•ˆè¯·æ±‚ï¼Œé¿å…å› ç­‰å¾…å¤±æ•ˆå¤„ç†è€Œé˜»å¡ CPU çš„æ­£å¸¸æ‰§è¡Œã€‚ã€‘


æœ€åçš„æ€»ç»“å¾ˆå¥½ï¼šcache-&gt;mesi-&gt;two queue-&gt;barrierçš„æ¼”è¿›
</code></pre><p>å¥½çš„ï¼æˆ‘å°†ç»“åˆæ—¶é—´çº¿ã€å…·ä½“æ¡ˆä¾‹å’ŒæŠ€æœ¯ç»†èŠ‚ï¼Œè¡¥å……å¹¶æ‰©å±•æ‚¨çš„ç¬”è®°å†…å®¹ï¼š</p>
<hr>
<h3 id="cpu-cache-ä¸å†…å­˜ä¸€è‡´æ€§æ¼”è¿›å²"><strong>CPU Cache ä¸å†…å­˜ä¸€è‡´æ€§æ¼”è¿›å²</strong></h3>
<h4 id="1-å•æ ¸æ—¶ä»£ç®€å•ç¼“å­˜1980så‰"><strong>1. å•æ ¸æ—¶ä»£ï¼šç®€å•ç¼“å­˜ï¼ˆ1980så‰ï¼‰</strong></h4>
<ul>
<li><strong>èƒŒæ™¯</strong>ï¼šCPU ä¸»é¢‘å¿«é€Ÿæå‡ï¼ˆMHz â†’ GHzï¼‰ï¼Œä½†å†…å­˜é€Ÿåº¦ä»…å¢é•¿ 10 å€ï¼Œå½¢æˆ &ldquo;Memory Wall&rdquo;ï¼ˆå†…å­˜å¢™ï¼‰ã€‚</li>
<li><strong>æ—©æœŸæ–¹æ¡ˆ</strong>ï¼š
<ul>
<li><strong>ç›´å†™ï¼ˆWrite-Throughï¼‰</strong>ï¼šæ¯æ¬¡å†™æ“ä½œåŒæ—¶æ›´æ–°ç¼“å­˜å’Œå†…å­˜ï¼Œç®€å•ä½†æ€§èƒ½å·®ã€‚</li>
<li><strong>å›å†™ï¼ˆWrite-Backï¼‰</strong>ï¼šä»…æ›´æ–°ç¼“å­˜ï¼Œæ ‡è®°è„ä½ï¼ˆDirty Bitï¼‰ï¼Œæ·˜æ±°æ—¶å†™å›å†…å­˜ï¼Œæå‡æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><strong>æ¡ˆä¾‹</strong>ï¼šIntel 80386ï¼ˆ1985ï¼‰é¦–æ¬¡å¼•å…¥ç‰‡ä¸Šç¼“å­˜ï¼ˆ8KBï¼‰ï¼Œé‡‡ç”¨ç®€å•å›å†™ç­–ç•¥ã€‚</li>
</ul>
<hr>
<h4 id="2-å¤šæ ¸æ—¶ä»£mesi-åè®®1990s"><strong>2. å¤šæ ¸æ—¶ä»£ï¼šMESI åè®®ï¼ˆ1990sï¼‰</strong></h4>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šå¤šæ ¸ CPU å„è‡ªç¼“å­˜åŒä¸€å†…å­˜åœ°å€æ—¶ï¼Œå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ</li>
<li><strong>MESI åè®®</strong>ï¼ˆ1990 å¹´æå‡ºï¼‰ï¼š
<ul>
<li><strong>çŠ¶æ€æœº</strong>ï¼šModifiedï¼ˆç‹¬å ä¿®æ”¹ï¼‰ã€Exclusiveï¼ˆç‹¬å æœªä¿®æ”¹ï¼‰ã€Sharedï¼ˆå…±äº«ï¼‰ã€Invalidï¼ˆå¤±æ•ˆï¼‰ã€‚</li>
<li><strong>æ€»çº¿å—…æ¢ï¼ˆBus Snoopingï¼‰</strong>ï¼šé€šè¿‡ç›‘å¬æ€»çº¿æ¶ˆæ¯ï¼ˆå¦‚ <code>Read</code>/<code>Invalidate</code>ï¼‰ç»´æŠ¤çŠ¶æ€ã€‚</li>
<li><strong>æ€§èƒ½ç“¶é¢ˆ</strong>ï¼šæ¯æ¬¡å†™æ“ä½œéœ€å¹¿æ’­å¤±æ•ˆè¯·æ±‚ï¼Œç­‰å¾…æ‰€æœ‰ CPU ç¡®è®¤ï¼ˆACKï¼‰ï¼Œå¯¼è‡´å»¶è¿Ÿã€‚</li>
</ul>
</li>
<li><strong>æ¡ˆä¾‹</strong>ï¼š
<ul>
<li><strong>Intel Pentium Proï¼ˆ1995ï¼‰</strong>ï¼šé¦–æ¬¡å®ç° MESIï¼Œæ”¯æŒå¤šæ ¸å…±äº« L2 ç¼“å­˜ã€‚</li>
<li><strong>AMD K6ï¼ˆ1997ï¼‰</strong>ï¼šé‡‡ç”¨ MOESI åè®®ï¼ˆå¢åŠ  Owned çŠ¶æ€ï¼‰ï¼Œä¼˜åŒ–å…±äº«æ•°æ®åœºæ™¯ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h4 id="3-å¼‚æ­¥ä¼˜åŒ–store-buffer-ä¸-invalidation-queue2000s"><strong>3. å¼‚æ­¥ä¼˜åŒ–ï¼šStore Buffer ä¸ Invalidation Queueï¼ˆ2000sï¼‰</strong></h4>
<h5 id="31-store-buffer"><strong>3.1 Store Buffer</strong></h5>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šMESI è¦æ±‚å†™æ“ä½œå¿…é¡»ç­‰å¾…æ‰€æœ‰ ACKï¼Œå¯¼è‡´ CPU åœé¡¿ï¼ˆStallï¼‰ã€‚</li>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå¼•å…¥ Store Bufferï¼ˆå†™ç¼“å†²åŒºï¼‰ã€‚
<ul>
<li><strong>å·¥ä½œæµç¨‹</strong>ï¼š
<ol>
<li>CPU å†™å…¥æ—¶ï¼Œæ•°æ®æš‚å­˜åˆ° Store Bufferï¼Œç»§ç»­æ‰§è¡Œåç»­æŒ‡ä»¤ã€‚</li>
<li>åå°å¼‚æ­¥å‘é€ <code>Invalidate</code> è¯·æ±‚ï¼Œç­‰å¾…å…¶ä»– CPU çš„ ACKã€‚</li>
<li>æ”¶åˆ°æ‰€æœ‰ ACK åï¼Œæ•°æ®ä» Store Buffer æäº¤åˆ°ç¼“å­˜ï¼ˆCache Lineï¼‰ã€‚</li>
</ol>
</li>
<li><strong>ä¼˜åŒ–æ•ˆæœ</strong>ï¼šå†™æ“ä½œå»¶è¿Ÿä» 100+ å‘¨æœŸé™ä½åˆ° 10 å‘¨æœŸå†…ã€‚</li>
<li><strong>å‰¯ä½œç”¨</strong>ï¼šå¯¼è‡´<strong>å†…å­˜ä¹±åº</strong>ï¼ˆMemory Reorderingï¼‰ï¼Œéœ€å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰æ§åˆ¶ã€‚</li>
</ul>
</li>
<li><strong>æ¡ˆä¾‹</strong>ï¼š
<ul>
<li><strong>Intel NetBurstï¼ˆ2000ï¼‰</strong>ï¼šé¦–æ¬¡å¼•å…¥æ·±åº¦ Store Bufferï¼ˆ20+ entriesï¼‰ï¼Œæå‡ Pentium 4 ååé‡ã€‚</li>
<li><strong>ARMv7ï¼ˆ2005ï¼‰</strong>ï¼šå…è®¸å¼±ä¸€è‡´æ€§æ¨¡å‹ï¼ˆWeak Memory Modelï¼‰ï¼Œä¾èµ–æ˜¾å¼å±éšœæŒ‡ä»¤ã€‚</li>
</ul>
</li>
</ul>
<h5 id="32-invalidation-queue"><strong>3.2 Invalidation Queue</strong></h5>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šæ¥æ”¶ <code>Invalidate</code> è¯·æ±‚çš„ CPU è‹¥åŒæ­¥å¤„ç†ï¼Œå¯èƒ½å› ç¹å¿™å»¶è¿Ÿ ACKã€‚</li>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå¼•å…¥ Invalidation Queueï¼ˆå¤±æ•ˆé˜Ÿåˆ—ï¼‰ã€‚
<ul>
<li><strong>å·¥ä½œæµç¨‹</strong>ï¼š
<ol>
<li>æ”¶åˆ° <code>Invalidate</code> è¯·æ±‚æ—¶ï¼Œç›´æ¥æ”¾å…¥é˜Ÿåˆ—å¹¶ç«‹å³å›å¤ ACKã€‚</li>
<li>åå°å¼‚æ­¥å¤„ç†é˜Ÿåˆ—ï¼Œå°†å¯¹åº” Cache Line æ ‡è®°ä¸º Invalidã€‚</li>
</ol>
</li>
<li><strong>ä¼˜åŒ–æ•ˆæœ</strong>ï¼šå‡å°‘ ACK å»¶è¿Ÿï¼Œæå‡æ•´ä½“ååé‡ã€‚</li>
<li><strong>å‰¯ä½œç”¨</strong>ï¼šå¯èƒ½å¯¼è‡´ CPU çŸ­æš‚è¯»åˆ°æ—§æ•°æ®ï¼ˆéœ€å±éšœå¼ºåˆ¶æ¸…ç©ºé˜Ÿåˆ—ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æ¡ˆä¾‹</strong>ï¼š
<ul>
<li><strong>IBM POWER4ï¼ˆ2001ï¼‰</strong>ï¼šé¦–æ¬¡å®ç°å¤šçº§ Invalidation Queueï¼Œæ”¯æŒ 64 æ ¸ç³»ç»Ÿã€‚</li>
<li><strong>AMD Zenï¼ˆ2017ï¼‰</strong>ï¼šé‡‡ç”¨åˆ†å¸ƒå¼å¤±æ•ˆé˜Ÿåˆ—ï¼Œä¼˜åŒ–å¤š CCD æ¶æ„å»¶è¿Ÿã€‚</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-å†…å­˜å±éšœmemory-barrier-2000"><strong>4. å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰ (2000)</strong></h4>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šStore Buffer å’Œ Invalidation Queue å¯¼è‡´æŒ‡ä»¤é‡æ’ï¼Œç ´åç¨‹åºé¡ºåºä¸€è‡´æ€§ã€‚</li>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤ã€‚
<ul>
<li><strong>ç±»å‹</strong>ï¼š
<ul>
<li><strong>å†™å±éšœï¼ˆStore Barrierï¼‰</strong>ï¼šæ¸…ç©º Store Bufferï¼Œç¡®ä¿å±éšœå‰çš„å†™æ“ä½œå¯¹å…¶ä»– CPU å¯è§ã€‚</li>
<li><strong>è¯»å±éšœï¼ˆLoad Barrierï¼‰</strong>ï¼šæ¸…ç©º Invalidation Queueï¼Œç¡®ä¿è¯»åˆ°æœ€æ–°æ•°æ®ã€‚</li>
<li><strong>å…¨å±éšœï¼ˆFull Barrierï¼‰</strong>ï¼šåŒæ—¶æ¸…ç©º Store Buffer å’Œ Invalidation Queueã€‚</li>
</ul>
</li>
<li><strong>æ¡ˆä¾‹</strong>ï¼š
<ul>
<li><strong>Linux å†…æ ¸ï¼ˆ2005+ï¼‰</strong>ï¼š<code>smp_wmb()</code>ï¼ˆå†™å±éšœï¼‰ã€<code>smp_rmb()</code>ï¼ˆè¯»å±éšœï¼‰ç”¨äºåŒæ­¥é”ã€RCU ç­‰ã€‚</li>
<li><strong>Java volatileï¼ˆ2004ï¼‰</strong>ï¼šJVM é€šè¿‡æ’å…¥ <code>lock addl $0x0, (%esp)</code> å®ç°å±éšœè¯­ä¹‰ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="å…¸å‹é—®é¢˜ä¸æ¡ˆä¾‹åˆ†æ"><strong>å…¸å‹é—®é¢˜ä¸æ¡ˆä¾‹åˆ†æ</strong></h3>
<h4 id="1-å¯è§æ€§é—®é¢˜visibility"><strong>1. å¯è§æ€§é—®é¢˜ï¼ˆVisibilityï¼‰</strong></h4>
<ul>
<li>
<p><strong>ç¤ºä¾‹</strong>ï¼šåŒçº¿ç¨‹å¾ªç¯æ£€æŸ¥ <code>flag</code> å˜é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// çº¿ç¨‹ A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>data <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;          <span style="color:#75715e">// å†™å…¥ Store Bufferï¼Œæœªæäº¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;           <span style="color:#75715e">// Store Buffer å¯èƒ½å…ˆäº data æäº¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// çº¿ç¨‹ B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">while</span> (flag <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>);  <span style="color:#75715e">// çœ‹åˆ° flag=1 ä½† data å¯èƒ½ä»æ˜¯æ—§å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">print</span>(data);
</span></span></code></pre></div></li>
<li>
<p><strong>è§£å†³</strong>ï¼šåœ¨ <code>data=42</code> åæ’å…¥å†™å±éšœï¼Œåœ¨ <code>while</code> å‰æ’å…¥è¯»å±éšœã€‚</p>
</li>
</ul>
<h4 id="2-ä¹±åºé—®é¢˜reordering"><strong>2. ä¹±åºé—®é¢˜ï¼ˆReorderingï¼‰</strong></h4>
<ul>
<li>
<p><strong>ç¤ºä¾‹</strong>ï¼šå•æ ¸æŒ‡ä»¤é‡æ’ï¼ˆAlpha å¤„ç†å™¨è‘—åæ¡ˆä¾‹ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">STORE</span> <span style="color:#66d9ef">A</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">1</span>           <span style="color:#75715e">; å­˜å…¥ Store Buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">LOAD</span> <span style="color:#66d9ef">B</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">0</span>            <span style="color:#75715e">; B å·²åœ¨ç¼“å­˜ä¸­ï¼Œç«‹å³è¯»åˆ° 0
</span></span></span></code></pre></div><ul>
<li>å…¶ä»– CPU å¯èƒ½çœ‹åˆ° <code>B=0</code> å…ˆäº <code>A=1</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>è§£å†³</strong>ï¼šé€šè¿‡ <code>mfence</code> æŒ‡ä»¤ç¦æ­¢é‡æ’ã€‚</p>
</li>
</ul>
<hr>
<h3 id="æ¼”è¿›æ€»ç»“"><strong>æ¼”è¿›æ€»ç»“</strong></h3>
<p>å•æ ¸ç¼“å­˜ â†’ MESI åè®® â†’ Store Buffer â†’ Invalidation Queue â†’ å†…å­˜å±éšœ</p>
<ul>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šæ¯ä¸€æ­¥éƒ½é€šè¿‡å¼‚æ­¥åŒ–ï¼ˆAsynchronyï¼‰æå‡ååé‡ã€‚</li>
<li><strong>å¤æ‚åº¦è½¬ç§»</strong>ï¼šç¡¬ä»¶ä¼˜åŒ–å¯¼è‡´è½¯ä»¶éœ€å¤„ç†å¯è§æ€§å’Œé¡ºåºé—®é¢˜ï¼Œå‚¬ç”Ÿå¹¶å‘åŸè¯­ï¼ˆé”ã€åŸå­å˜é‡ã€RCUï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="å»¶ä¼¸æ–¹å‘"><strong>å»¶ä¼¸æ–¹å‘</strong></h3>
<ol>
<li><strong>ç°ä»£æ‰©å±•</strong>ï¼š
<ul>
<li><strong>MOESI</strong>ï¼šAMD æå‡ºçš„åè®®ï¼Œå…è®¸ç¼“å­˜ç›´æ¥å…±äº«è„æ•°æ®ã€‚</li>
<li><strong>Directory-Based åè®®</strong>ï¼šNUMA æ¶æ„ï¼ˆå¦‚ EPYCï¼‰ç”¨ç›®å½•é›†ä¸­ç®¡ç†ä¸€è‡´æ€§ã€‚</li>
</ul>
</li>
<li><strong>æœªæ¥è¶‹åŠ¿</strong>ï¼š
<ul>
<li><strong>ç¡…å…‰äº’è¿</strong>ï¼šç”¨å…‰ä¿¡å·åŠ é€Ÿä¸€è‡´æ€§æ¶ˆæ¯ä¼ é€’ï¼ˆå¦‚ Intel çš„é›†æˆå…‰å­å­¦ï¼‰ã€‚</li>
<li><strong>å¼‚æ„ä¸€è‡´æ€§</strong>ï¼šGPU/CPU ç»Ÿä¸€å†…å­˜ï¼ˆå¦‚ NVIDIA Hopper çš„ NVLink-C2Cï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p>å¸Œæœ›è¿™äº›è¡¥å……èƒ½è®©çŸ¥è¯†ç»“æ„æ›´å®Œæ•´ï¼å¦‚æœéœ€è¦è¿›ä¸€æ­¥å±•å¼€æŸä¸ªç‚¹ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚</p>

        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
          </div>
        </div>
        
          <div class="row">
            <div class="col-xs-12">
              
            </div>
          </div>

          



          
          
          <div style="height: 50px;"></div>
          
          <div class="post-comments">
            <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://joway.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

          </div>
          
        

        <div class="site-footer">
  
  
</div>

      </div>
    </div>
  </article>

  

<script>
  
  
    
    
  
</script>

  

</body>

</html>